# Sincroniza√ß√£o de Clientes com Shopify

## Vis√£o Geral

A Terravik utiliza uma arquitetura h√≠brida onde os dados de clientes s√£o gerenciados pelo Supabase, mas sincronizados com o Shopify para pedidos e checkout.

## Campos da Tabela `profiles`

### Dados B√°sicos
- `id` (UUID) - Primary key, sincronizado com Supabase Auth
- `email` - E-mail do usu√°rio (n√£o edit√°vel)
- `full_name` - Nome completo do cliente
- `phone` - Telefone/WhatsApp com m√°scara (XX) XXXXX-XXXX
- `avatar_url` - URL p√∫blica da foto de perfil (Supabase Storage)

### Endere√ßo
- `address` (JSONB) - Objeto com estrutura:
  ```json
  {
    "cep": "00000-000",
    "street": "Nome da rua",
    "number": "123",
    "complement": "Apto 45",
    "neighborhood": "Bairro",
    "city": "Cidade",
    "state": "UF"
  }
  ```

### Sincroniza√ß√£o Shopify
- `shopify_customer_id` - ID do cliente no Shopify (preenchido via webhook)
- `shopify_email` - E-mail usado no Shopify (pode diferir do auth)

### Gamifica√ß√£o
- `xp_total` - Total de XP acumulado
- `level` - N√≠vel atual do usu√°rio
- `streak_days` - Dias consecutivos de atividade

### Sistema
- `role` - Papel do usu√°rio (customer | admin | super_admin)
- `created_at` - Data de cria√ß√£o
- `updated_at` - Data da √∫ltima atualiza√ß√£o
- `last_activity_date` - √öltima atividade registrada

## Fluxo de Sincroniza√ß√£o

### 1. Cadastro no Site (Supabase)
```
Usu√°rio cadastra ‚Üí Supabase Auth cria usu√°rio ‚Üí Trigger cria profile ‚Üí shopify_customer_id = null
```

### 2. Primeiro Pedido (Shopify Webhook)
```
Usu√°rio faz pedido ‚Üí Shopify cria customer ‚Üí Webhook customers/create ‚Üí Atualiza profile com shopify_customer_id
```

### 3. Atualiza√ß√£o de Dados
```
Usu√°rio edita perfil ‚Üí Atualiza Supabase ‚Üí [Futura] Sincroniza com Shopify via API
```

## Regras de Neg√≥cio

### Upload de Avatar
- **Formato:** Apenas imagens (jpg, png, gif, webp)
- **Tamanho m√°ximo:** 2MB
- **Bucket:** `banners` (path: `avatars/`)
- **Nomenclatura:** `{user_id}-{timestamp}.{ext}`

### Busca de CEP
- **API:** ViaCEP (https://viacep.com.br/ws/{cep}/json/)
- **Auto-fill:** Rua, Bairro, Cidade, Estado
- **Valida√ß√£o:** 8 d√≠gitos num√©ricos
- **Formato:** 00000-000

### Valida√ß√µes
- **Nome completo:** Obrigat√≥rio, m√≠nimo 3 caracteres
- **Telefone:** Opcional, m√°scara (XX) XXXXX-XXXX
- **CEP:** Opcional, formato 00000-000
- **Estado:** M√°ximo 2 caracteres, uppercase

## Interface da P√°gina "Meus Dados" (Arquitetura H√≠brida Inteligente)

### ‚úÖ IMPLEMENTADO - Estrat√©gia H√≠brida

A p√°gina √© dividida em 3 se√ß√µes estrat√©gicas:

#### **SE√á√ÉO 1: Dados Comerciais (Shopify)** üîí READONLY
- **Fonte:** Shopify Customer API via GraphQL
- **Campos:** Nome, telefone, endere√ßo
- **Edit√°vel:** ‚ùå N√£o (exibe + link "Editar no Shopify")
- **Sincroniza√ß√£o:** Autom√°tica via webhook `customers/update`
- **Motivo:** Dados de checkout/pagamento devem ser gerenciados pelo Shopify

#### **SE√á√ÉO 2: Personaliza√ß√£o (Supabase)** ‚úèÔ∏è EDIT√ÅVEL
- **Fonte:** Tabela `profiles` do Supabase
- **Campos:** Avatar, prefer√™ncias de notifica√ß√£o, configura√ß√µes da academia
- **Edit√°vel:** ‚úÖ Sim (salva direto no Supabase)
- **Sincroniza√ß√£o:** N√£o sincroniza com Shopify (dados exclusivos da plataforma)
- **Motivo:** Funcionalidades customizadas que o Shopify n√£o oferece

#### **SE√á√ÉO 3: Gamifica√ß√£o (Supabase)** üëÄ READONLY
- **Fonte:** Tabela `profiles` do Supabase
- **Campos:** XP total, n√≠vel, sequ√™ncia de dias
- **Edit√°vel:** ‚ùå N√£o (atualiza√ß√£o autom√°tica)
- **Sincroniza√ß√£o:** N√£o sincroniza com Shopify
- **Motivo:** Sistema de recompensas interno da Terravik

### Funcionalidades Implementadas
- ‚úÖ Busca de dados do Shopify via Admin API (GraphQL)
- ‚úÖ Upload de avatar no Supabase Storage
- ‚úÖ Prefer√™ncias de comunica√ß√£o (email, WhatsApp, newsletter)
- ‚úÖ Feedback visual e loading states
- ‚úÖ Link para editar dados comerciais no Shopify Account
- ‚úÖ Indicador de sincroniza√ß√£o com Shopify
- ‚úÖ Tratamento de erros e estados vazios

## Pr√≥ximos Passos

### Curto Prazo
- [ ] Criar bucket dedicado `avatars` no Supabase Storage
- [ ] Adicionar valida√ß√£o de CPF/CNPJ (campo futuro)
- [ ] Implementar sincroniza√ß√£o bidirecional com Shopify

### M√©dio Prazo
- [ ] Adicionar hist√≥rico de altera√ß√µes
- [ ] Implementar verifica√ß√£o de e-mail/telefone
- [ ] Criar integra√ß√£o com Shopify Customer API para sincronizar dados editados

### Longo Prazo
- [ ] Implementar Shopify Multipass para SSO
- [ ] Adicionar op√ß√£o de exportar dados (LGPD)
- [ ] Criar painel de privacidade (gerenciamento de consentimentos)

## Refer√™ncias

- [Shopify Customer API](https://shopify.dev/docs/api/admin-rest/2024-01/resources/customer)
- [Supabase Storage](https://supabase.com/docs/guides/storage)
- [ViaCEP API](https://viacep.com.br/)
